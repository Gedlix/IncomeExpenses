<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gedlix Tracker</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bb86fc">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2344/2344132.png">

    <style>
        :root { --primary: #bb86fc; --bg: #0f0f0f; --card: #1e1e1e; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: #e0e0e0; padding: 15px; margin: 0; display: flex; justify-content: center; }
        .container { background: var(--card); padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-width: 400px; margin-top: 20px; border: 1px solid #333; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; font-size: 24px; }
        .form-group { margin-bottom: 18px; position: relative; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #bbb; font-size: 14px; }
        
        /* Mobile Friendly Inputs */
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #444; border-radius: 10px; 
            background: #252525; color: #fff; font-size: 16px; /* 16px prevents auto-zoom on iOS */
            box-sizing: border-box; transition: 0.3s; -webkit-appearance: none; 
        }
        input:focus, select:focus { border-color: var(--primary); outline: none; background: #2d2d2d; }

        /* Custom Dropdown Arrow */
        .select-wrapper { position: relative; }
        .select-wrapper::after { 
            content: 'â–¼'; position: absolute; right: 12px; top: 50%; transform: translateY(-50%); 
            color: var(--primary); font-size: 12px; pointer-events: none; 
        }

        #otherInputWrapper { display: none; margin-top: 10px; }
        .btn-container { display: flex; flex-direction: column; gap: 12px; margin-top: 25px; }
        button { padding: 15px; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: bold; color: #fff; transition: 0.2s; }
        .btn-insert { background: linear-gradient(135deg, #7e57c2, #5e35b1); }
        .btn-reset { background: #333; }
        #statusContainer { text-align: center; margin-top: 15px; font-size: 13px; color: var(--primary); background: rgba(187,134,252,0.1); padding: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2>Gedlix Tracker</h2>
    <form id="dataForm">
        <div class="form-group">
            <label>Date</label>
            <input type="date" id="date" name="date" required>
        </div>

        <div class="form-group">
            <label>Description</label>
            <div class="select-wrapper">
                <select id="descSelect">
                    <option value="Current Bill">Current Bill</option>
                    <option value="Vegetable">Vegetable</option>
                    <option value="Facebook Ad">Facebook Ad</option>
                    <option value="Router Package">Router Package</option>
                    <option value="Other">Other (Type custom...)</option>
                </select>
            </div>
            <div id="otherInputWrapper">
                <input type="text" id="customDesc" placeholder="Enter custom description">
            </div>
            <input type="hidden" id="finalDesc" name="description">
        </div>

        <div class="form-group">
            <label>Category</label>
            <div class="select-wrapper">
                <select name="category">
                    <option value="My">My</option>
                    <option value="Parents">Parents</option>
                    <option value="Siblings">Siblings</option>
                    <option value="Vehicle">Vehicle</option>
                    <option value="Hire">Hire</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Type</label>
            <div class="select-wrapper">
                <select name="type">
                    <option value="Income">Income</option>
                    <option value="Expenses">Expenses</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Amount (Rs.)</label>
            <input type="number" name="price" step="0.01" placeholder="0.00" required>
        </div>
        
        <div class="btn-container">
            <button type="submit" class="btn-insert" id="submitBtn">Insert Data</button>
            <button type="button" class="btn-reset" onclick="resetForm()">Reset Form</button>
        </div>

        <div id="statusContainer">ðŸ”„ Syncing: <span id="pendingCount">0</span></div>
    </form>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyugQ9FE4Gw9pPKwlq_-aRzQKYZv92X-RK7dfU9FeV7R1CvIy3zk0syAvi-Uc-QC-Ml/exec';
    const form = document.getElementById('dataForm');
    const submitBtn = document.getElementById('submitBtn');
    const descSelect = document.getElementById('descSelect');
    const otherWrapper = document.getElementById('otherInputWrapper');
    let db;

    // Set Date
    document.getElementById('date').valueAsDate = new Date();

    // Handle "Other" visibility
    descSelect.addEventListener('change', function() {
        otherWrapper.style.display = (this.value === 'Other') ? 'block' : 'none';
    });

    // DB Setup
    const request = indexedDB.open('GedlixTrackerDB', 2); // Version up to trigger update
    request.onupgradeneeded = (e) => {
        if (!e.target.result.objectStoreNames.contains('pendingData')) {
            e.target.result.createObjectStore('pendingData', { autoIncrement: true });
        }
    };
    request.onsuccess = (e) => { db = e.target.result; updateCount(); syncData(); };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";

        // Set final description
        document.getElementById('finalDesc').value = (descSelect.value === 'Other') ? document.getElementById('customDesc').value : descSelect.value;

        const data = {};
        new FormData(form).forEach((v, k) => data[k] = v);

        if (navigator.onLine) {
            await send(data);
        } else {
            saveLocally(data);
        }
    });

    async function send(data) {
        try {
            await fetch(scriptURL, { method: 'POST', body: new URLSearchParams(data), mode: 'no-cors' });
            alert("Success!");
            resetForm();
        } catch (e) { saveLocally(data); }
        finally { submitBtn.disabled = false; submitBtn.innerText = "Insert Data"; updateCount(); }
    }

    function saveLocally(data) {
        const tx = db.transaction(['pendingData'], 'readwrite');
        tx.objectStore('pendingData').add(data);
        tx.oncomplete = () => {
            alert("Saved locally!");
            resetForm();
            submitBtn.disabled = false;
            submitBtn.innerText = "Insert Data";
            updateCount();
        };
    }

    async function syncData() {
        if (!navigator.onLine || !db) return;
        const tx = db.transaction(['pendingData'], 'readonly');
        const store = tx.objectStore('pendingData');
        const records = await new Promise(r => store.getAll().onsuccess = (e) => r(e.target.result));
        const keys = await new Promise(r => store.getAllKeys().onsuccess = (e) => r(e.target.result));

        for (let i = 0; i < records.length; i++) {
            try {
                await fetch(scriptURL, { method: 'POST', body: new URLSearchParams(records[i]), mode: 'no-cors' });
                const delTx = db.transaction(['pendingData'], 'readwrite');
                await new Promise(r => delTx.objectStore('pendingData').delete(keys[i]).onsuccess = r);
                updateCount();
                await new Promise(r => setTimeout(r, 500));
            } catch (e) { break; }
        }
    }

    function updateCount() {
        if (!db) return;
        const req = db.transaction(['pendingData'], 'readonly').objectStore('pendingData').count();
        req.onsuccess = () => {
            const c = req.result;
            document.getElementById('statusContainer').style.display = c > 0 ? 'block' : 'none';
            document.getElementById('pendingCount').innerText = c;
        };
    }

    window.addEventListener('online', syncData);
    function resetForm() { 
        form.reset(); 
        document.getElementById('date').valueAsDate = new Date();
        otherWrapper.style.display = 'none';
    }

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js?v=2');
    }
</script>
</body>
</html>

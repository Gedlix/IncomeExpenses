<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gedlix Tracker</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bb86fc">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2344/2344132.png">

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #0f0f0f, #1a1a1a); color: #e0e0e0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; background-attachment: fixed; }
        .container { background: #1e1e1e; padding: 28px; border-radius: 16px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); width: 100%; max-width: 420px; border: 1px solid #333; margin: 20px auto; }
        h2 { text-align: center; color: #bb86fc; margin-bottom: 32px; font-size: 26px; font-weight: 600; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #cfcfcf; font-size: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #444; border-radius: 12px; box-sizing: border-box; font-size: 16px; background-color: #2a2a2a; color: #ffffff; transition: all 0.3s ease; appearance: none; } /* appearance: none ‡∂∏‡∂ü‡∑í‡∂±‡∑ä ‡∂∏‡∑ú‡∂∂‡∂∫‡∑í‡∂Ω‡∑ä style ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫ ‡∂ö‡∂ª‡∂∫‡∑í */
        input:focus, select:focus, textarea:focus { outline: none; border-color: #bb86fc; box-shadow: 0 0 0 4px rgba(187, 134, 252, 0.25); background-color: #333; }
        
        /* Dropdown ‡∂ë‡∂ö‡∂ß ‡∂ä‡∂≠‡∂Ω‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏ */
        .select-wrapper { position: relative; }
        .select-wrapper::after { content: '‚ñº'; font-size: 12px; color: #bb86fc; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); pointer-events: none; }

        #otherDescription { display: none; margin-top: 10px; border-color: #7e57c2; }
        .btn-container { display: flex; flex-direction: column; gap: 14px; margin-top: 25px; }
        button { padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: bold; color: white; transition: all 0.2s ease; }
        .btn-insert { background: linear-gradient(135deg, #7e57c2, #5e35b1); }
        .btn-reset { background: linear-gradient(135deg, #424242, #212121); }
        #statusContainer { text-align: center; margin-top: 20px; font-size: 14px; color: #bb86fc; font-weight: bold; background: rgba(187, 134, 252, 0.1); padding: 12px; border-radius: 10px; border: 1px dashed #bb86fc; display: none; }
        @media (max-width: 480px) { body { padding: 10px; } .container { padding: 24px; } }
    </style>
</head>
<body>

<div class="container">
    <h2>Gedlix Tracker</h2>
    <form id="dataForm">
        <div class="form-group">
            <label for="date">Date</label>
            <input type="date" id="date" name="date" required>
        </div>

        <div class="form-group">
            <label for="descriptionSelect">Description</label>
            <div class="select-wrapper">
                <select id="descriptionSelect" onchange="checkDescription(this)">
                    <option value="Current Bill">Current Bill</option>
                    <option value="Vegetable">Vegetable</option>
                    <option value="Facebook Ad">Facebook Ad</option>
                    <option value="Router Package">Router Package</option>
                    <option value="Other">Other (Type custom...)</option>
                </select>
            </div>
            <input type="text" id="otherDescription" placeholder="Enter custom description">
            <input type="hidden" id="finalDescription" name="description">
        </div>

        <div class="form-group">
            <label for="category">Category</label>
            <div class="select-wrapper">
                <select id="category" name="category">
                    <option value="My">My</option>
                    <option value="Parents">Parents</option>
                    <option value="Siblings">Siblings</option>
                    <option value="Vehicle">Vehicle</option>
                    <option value="Hire">Hire</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="type">Type</label>
            <div class="select-wrapper">
                <select id="type" name="type">
                    <option value="Income">Income</option>
                    <option value="Expenses">Expenses</option>
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="price">Amount (Rs.)</label>
            <input type="number" id="price" name="price" step="0.01" placeholder="0.00" required>
        </div>
        
        <div class="btn-container">
            <button type="submit" class="btn-insert" id="submitBtn">Insert Data</button>
            <button type="button" class="btn-reset" id="resetBtn">Reset Form</button>
        </div>

        <div id="statusContainer">üîÑ Pending to Sync: <span id="pendingCount">0</span></div>
    </form>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyugQ9FE4Gw9pPKwlq_-aRzQKYZv92X-RK7dfU9FeV7R1CvIy3zk0syAvi-Uc-QC-Ml/exec';
    const form = document.getElementById('dataForm');
    const submitBtn = document.getElementById('submitBtn');
    let db;

    document.getElementById('date').valueAsDate = new Date();

    // Other box ‡∂ë‡∂ö ‡∂¥‡∑è‡∂Ω‡∂±‡∂∫ ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
    function checkDescription(select) {
        const otherInput = document.getElementById('otherDescription');
        if (select.value === 'Other') {
            otherInput.style.display = 'block';
            otherInput.required = true;
        } else {
            otherInput.style.display = 'none';
            otherInput.required = false;
        }
    }

    // IndexedDB Setup
    const request = indexedDB.open('GedlixTrackerDB', 1);
    request.onupgradeneeded = (e) => { e.target.result.createObjectStore('pendingData', { autoIncrement: true }); };
    request.onsuccess = (e) => { db = e.target.result; updatePendingCount(); syncData(); };

    form.addEventListener('submit', e => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";

        // Description ‡∂Ö‡∂ú‡∂∫ ‡∂≠‡∑ù‡∂ª‡∑è‡∂ú‡∑ê‡∂±‡∑ì‡∂∏
        const descSelect = document.getElementById('descriptionSelect');
        const otherInput = document.getElementById('otherDescription');
        document.getElementById('finalDescription').value = (descSelect.value === 'Other') ? otherInput.value : descSelect.value;

        const formData = new FormData(form);
        const dataObj = {};
        formData.forEach((value, key) => dataObj[key] = value);

        if (navigator.onLine) {
            sendData(dataObj);
        } else {
            saveToOffline(dataObj);
        }
    });

    function sendData(data) {
        fetch(scriptURL, { method: 'POST', body: new URLSearchParams(data), mode: 'no-cors' })
        .then(() => { alert("Data inserted successfully!"); resetForm(); })
        .catch(() => saveToOffline(data))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerText = "Insert Data";
            updatePendingCount();
        });
    }

    function saveToOffline(data) {
        const transaction = db.transaction(['pendingData'], 'readwrite');
        transaction.objectStore('pendingData').add(data);
        transaction.oncomplete = () => {
            alert("Saved locally!");
            resetForm();
            submitBtn.disabled = false;
            submitBtn.innerText = "Insert Data";
            updatePendingCount();
        };
    }

    async function syncData() {
        if (!navigator.onLine || !db) return;
        const tx = db.transaction(['pendingData'], 'readonly');
        const store = tx.objectStore('pendingData');
        const records = await new Promise(res => { store.getAll().onsuccess = (e) => res(e.target.result); });
        const keys = await new Promise(res => { store.getAllKeys().onsuccess = (e) => res(e.target.result); });
        
        if (records.length === 0) return;
        for (let i = 0; i < records.length; i++) {
            try {
                await fetch(scriptURL, { method: 'POST', body: new URLSearchParams(records[i]), mode: 'no-cors' });
                const delTx = db.transaction(['pendingData'], 'readwrite');
                await new Promise(res => { delTx.objectStore('pendingData').delete(keys[i]).onsuccess = res; });
                updatePendingCount();
                await new Promise(r => setTimeout(r, 500)); 
            } catch (err) { break; }
        }
    }

    function updatePendingCount() {
        if (!db) return;
        const countReq = db.transaction(['pendingData'], 'readonly').objectStore('pendingData').count();
        countReq.onsuccess = () => {
            const count = countReq.result;
            document.getElementById('statusContainer').style.display = count > 0 ? 'block' : 'none';
            document.getElementById('pendingCount').innerText = count;
        };
    }

    window.addEventListener('online', syncData);
    function resetForm() { 
        form.reset(); 
        document.getElementById('date').valueAsDate = new Date(); 
        document.getElementById('otherDescription').style.display = 'none';
    }
    document.getElementById('resetBtn').addEventListener('click', resetForm);
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }
</script>
</body>
</html>

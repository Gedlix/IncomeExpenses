<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashFlow</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bb86fc">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2344/2344132.png">

    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #0f0f0f, #1a1a1a); color: #e0e0e0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; background-attachment: fixed; }
        .container { background: #1e1e1e; padding: 28px; border-radius: 16px; box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6); width: 100%; max-width: 420px; border: 1px solid #333; margin: 20px auto; }
        h2 { text-align: center; color: #bb86fc; margin-bottom: 32px; font-size: 26px; font-weight: 600; text-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #cfcfcf; font-size: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid #444; border-radius: 12px; box-sizing: border-box; font-size: 16px; background-color: #2a2a2a; color: #ffffff; transition: all 0.3s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #bb86fc; box-shadow: 0 0 0 4px rgba(187, 134, 252, 0.25); background-color: #333; }
        textarea { resize: vertical; min-height: 80px; }
        .btn-container { display: flex; flex-direction: column; gap: 14px; margin-top: 25px; }
        button { padding: 16px; border: none; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: bold; color: white; transition: all 0.2s ease; }
        .btn-insert { background: linear-gradient(135deg, #7e57c2, #5e35b1); }
        .btn-reset { background: linear-gradient(135deg, #424242, #212121); }
        #statusContainer { text-align: center; margin-top: 20px; font-size: 14px; color: #bb86fc; font-weight: bold; background: rgba(187, 134, 252, 0.1); padding: 12px; border-radius: 10px; border: 1px dashed #bb86fc; display: none; }
        @media (max-width: 480px) { body { padding: 10px; } .container { padding: 24px; } }
    </style>
</head>
<body>

<div class="container">
    <h2>CashFlow</h2>
    <form id="dataForm">
        <div class="form-group"><label>Date</label><input type="date" id="date" name="date" required></div>
        <div class="form-group"><label>Description</label><textarea id="description" name="description" placeholder="Enter description" required></textarea></div>
        <div class="form-group">
  <label>Category</label>
  <select id="category" name="category">
    <option value="My">My</option>
    <option value="Home">Home</option>
    <option value="Bill and Package">Bill and Package</option>
    <option value="Vehicle">Vehicle</option>
    <option value="Parent">Parent</option>
    <option value="Sibling">Sibling</option>
    <option value="Girlfriend">Girlfriend</option>
    <option value="Business">Business</option>
    <option value="Friend">Friend</option>
  </select>
</div>
        <div class="form-group">
            <label>Type</label>
            <select id="type" name="type">
                <option value="Expenses">Expenses</option>
                <option value="Income">Income</option>
            </select>
        </div>
        <div class="form-group"><label>Amount (Rs.)</label><input type="number" id="price" name="price" step="0.01" placeholder="0.00" required></div>
        <div class="btn-container">
            <button type="submit" class="btn-insert" id="submitBtn">Insert Data</button>
            <button type="button" class="btn-reset" id="resetBtn">Reset Form</button>
        </div>
        <div id="statusContainer">ðŸ”„ Pending to Sync: <span id="pendingCount">0</span></div>
    </form>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyugQ9FE4Gw9pPKwlq_-aRzQKYZv92X-RK7dfU9FeV7R1CvIy3zk0syAvi-Uc-QC-Ml/exec';
    const form = document.getElementById('dataForm');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    let db;

    document.getElementById('date').valueAsDate = new Date();

    const request = indexedDB.open('GedlixTrackerDB', 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains('pendingData')) {
            db.createObjectStore('pendingData', { autoIncrement: true });
        }
    };

    request.onsuccess = (e) => {
        db = e.target.result;
        updatePendingCount();
        syncData(); 
    };

    // Pending Count à¶‘à¶š à¶±à·’à·€à·à¶»à¶¯à·’à·€ à¶´à·™à¶±à·Šà·€à·“à¶¸à¶§
    function updatePendingCount() {
        if (!db) return;
        const transaction = db.transaction(['pendingData'], 'readonly');
        const store = transaction.objectStore('pendingData');
        const countReq = store.count();

        countReq.onsuccess = () => {
            const count = countReq.result;
            const statusBox = document.getElementById('statusContainer');
            const countLabel = document.getElementById('pendingCount');
            statusBox.style.display = count > 0 ? 'block' : 'none';
            countLabel.innerText = count;
        };
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = "Processing...";
        const dataObj = {};
        new FormData(form).forEach((value, key) => dataObj[key] = value);

        if (navigator.onLine) {
            sendData(dataObj);
        } else {
            saveToOffline(dataObj);
        }
    });

    function sendData(data) {
        fetch(scriptURL, { method: 'POST', body: new URLSearchParams(data) })
        .then(() => {
            alert("Data inserted successfully!");
            resetForm();
        })
        .catch(() => saveToOffline(data))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerText = "Insert Data";
            updatePendingCount();
        });
    }

    function saveToOffline(data) {
        const transaction = db.transaction(['pendingData'], 'readwrite');
        const store = transaction.objectStore('pendingData');
        store.add(data);
        transaction.oncomplete = () => {
            alert("Offline: à¶¯à¶­à·Šà¶­ à·ƒà·”à¶»à·à¶šà·’à¶«à·’.");
            resetForm();
            submitBtn.disabled = false;
            submitBtn.innerText = "Insert Data";
            updatePendingCount(); 
        };
    }

    // Sync à¶šà·’à¶»à·“à¶¸à·š Function à¶‘à¶š à¶±à·’à·€à·à¶»à¶¯à·’ à¶šà¶» à¶‡à¶­
    function syncData() {
        if (!navigator.onLine || !db) return;

        const transaction = db.transaction(['pendingData'], 'readonly');
        const store = transaction.objectStore('pendingData');
        const cursorRequest = store.openCursor();

        cursorRequest.onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const currentData = cursor.value;
                const currentKey = cursor.key;

                fetch(scriptURL, { method: 'POST', body: new URLSearchParams(currentData) })
                .then(response => {
                    if(response.ok) {
                        // à·ƒà·à¶»à·Šà¶®à¶šà·€ à¶ºà·à·€à·”à¶«à·” à¶´à·ƒà·” à¶¯à¶­à·Šà¶­à¶º à¶¸à·à¶šà·“à¶¸
                        const deleteTx = db.transaction(['pendingData'], 'readwrite');
                        deleteTx.objectStore('pendingData').delete(currentKey);
                        
                        // à¶¸à¶šà· à¶¯à·à¶¸à·“à¶¸ à¶…à·€à·ƒà¶±à·Š à·€à·– à¶´à·ƒà·” à¶´à¶¸à¶«à¶šà·Š UI à¶‘à¶š Update à¶šà·’à¶»à·“à¶¸
                        deleteTx.oncomplete = () => {
                            updatePendingCount();
                        };
                    }
                })
                .catch(err => console.log("Sync failed for record", err));
                
                cursor.continue();
            }
        };
    }

    window.addEventListener('online', syncData);

    function resetForm() {
        form.reset();
        document.getElementById('date').valueAsDate = new Date();
    }
    
    resetBtn.addEventListener('click', resetForm);

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
        });
    }
</script>
</body>
</html>


